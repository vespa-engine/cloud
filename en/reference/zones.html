---
# Copyright Verizon Media. All rights reserved.
title: "Zones: environments and regions"
layout: page
---

<!-- ToDo: move to style sheet later -->
<style>
    td { vertical-align: top; }
</style>


<p>
An application can be deployed to one or more <em>zones</em>,
which is a combination of an <em>environment</em> and a <em>region</em>.
</p>

<table class="table">
  <thead>
  <tr><th>Name</th><th>Expiry</th><th>Cluster sizes</th><th>Regions</th></tr>
  </thead>
  <tbody>
  <tr>
    <td id="dev">dev</td>
    <td>7 days</td> <!-- https://git.vzbuilders.com/vespa/vespa-yahoo/blob/master/hosted/zone-specification/src/main/java/com/yahoo/vespa/hosted/spec/Zones.java#L1291 -->
    <td>1</td>
    <td>
      <table class="table">
        <tbody>
        <tr><td>aws-us-east-1c</td></tr>
        </tbody>
      </table>
    </td>
  </tr><tr>
    <td id="perf">perf</td>
    <td>7 days</td>
    <td>min(3, spec)</td>
    <td>
      <table class="table">
        <tbody>
        <tr><td>aws-us-east-1c</td></tr>
        </tbody>
      </table>
    </td>
  </tr><tr>
    <td id="test">test</td>
    <td>2 hours</td>
    <td>1</td>
    <td>
      <table class="table">
        <tbody>
        <tr><td>aws-us-east-1c</td></tr>
        </tbody>
      </table>
    </td>
  </tr><tr>
    <td id="staging">staging</td>
    <td>6 hours</td>
    <td>min(max(2, 0.1 * spec), spec)</td>
    <td>
      <table class="table">
        <tbody>
        <tr><td>aws-us-east-1c</td></tr>
        </tbody>
      </table>
    </td>
  </tr><tr>
    <td id="prod">prod</td>
    <td>No expiry</td>
    <td>max(2, spec)</td>
    <td>
      <table class="table">
        <tbody>
          <tr><td>aws-us-east-1c</td></tr>
          <tr><td>aws-us-west-2a</td></tr>
          <tr><td>aws-eu-west-1a</td></tr>
          <tr><td>aws-ap-northeast-1a</td></tr>
        </tbody>
      </table>
    </td>
  </tr>
  </tbody>
</table>
<p>
  If your deployment requires zones not listed here, contact the Vespa Team to have it made available.
</p>
<p>
  If the application requires instance/zone-specific configuration,
  use <a href="services#instance-environment-and-region-variants">
  environment and region variants</a>.
</p>



<h2 id="dev-and-perf-environments">Dev and Perf environments</h2>
<p>
  Instances in <em>dev</em> and <em>perf</em> environments are deployed to manually,
  used for manual development/performance testing.
</p>
<p>
  In order to easily deploy application packages from prod applications,
  resources are downscaled in <em>dev</em> and <em>perf</em>.
  To control the resources you get in these zones,
  specify them explicitly for the environment in question (<em>dev</em> or <em>perf</em>) as described in
  <a href="services#instance-environment-and-region-variants">environment and region variants</a>.
</p>
<p>
  The <em>dev</em> environment is default, to deploy to the <em>perf</em> environment, use:
</p>
<pre>
$ mvn package vespa:deploy -Denvironment=perf
</pre>



<h2 id="test-and-staging-environments">Test and staging environments</h2>
<p>
  Whenever an application package is submitted to <em>prod</em>,
  instances are set up in <em>test</em> and <em>staging</em> to
  <a href="../automated-deployments">verify prod deployments</a>.
  See <a href="testing#system-tests">automated system tests</a> and
  <a href="testing#staging-tests">automated staging tests</a>.
</p>



<h2 id="production-environment">Production environment</h2>
<p>
  Hosts all production deployments.
  deployed to in production using <a href="deployment">deployment.xml</a> (prod),
</p>
<p>
  Deployments in <em>prod</em> must have at least one more node than required to handle peak load.
  A cluster is a <em>container</em> or <em>content</em> cluster,
  and a regular application has a container <em>and</em> a content cluster.
  A minimal, typical <em>prod</em> deployment therefore has 4 nodes.
</p>


<h2 id="vespa-version">Vespa version</h2>
<p>
  In <em>dev</em> and <em>perf</em>, the latest active Vespa version is used when deploying.
  An instance is not upgraded, unless deployed to.
  This means that some times, a deploy takes longer than normal,
  as it invokes a Vespa upgrade before deploying the application package.
</p>





<h2 id="routing-control">Routing control</h2>

<p>Vespa Cloud has two mechanisms for manually controlling routing of requests to a zone:</p>

<ul class="howto">
  <li>Endpoint configuration. This is changed by updating
      <a href="deployment">deployment.xml</a> and redeploying</li>
  <li>The application API</li>
</ul>

<p>The example below describes the latter mechanism.</p>


<h3>Inspect current routing status</h3>

<p>
With a tenant name <em>foo</em> and an application named <em>bar</em>,
the routing status for the <em>default</em> instance of the application in
zone <em>prod.aws-us-east-1c</em> can inspected at the following path:
<pre>
$ curl https://console.vespa.oath.cloud/api/routing/v1/status/tenant/foo/application/bar/instance/default/environment/prod/region/aws-us-east-1c | jq .
{
  "deployments": [
    {
      "routingMethod": "exclusive",
      "instance": "foo:bar:default",
      "environment": "prod",
      "region": "aws-us-east-1c",
      "status": "in",
      "agent": "system",
      "changedAt": 0
    }
  ]
}
</pre>

<p>
In this particular example, the status of zone <em>prod.aws-us-east-1c</em>
is <em>in</em> and the zone should be receiving requests.
</p>


<h3>Set zone out</h3>

<p>
In case of a production emergency,
a zone can be manully set out to prevent it from receiving requests:
</p>

<pre>
$ curl -XPOST https://console.vespa.oath.cloud/api/routing/v1/inactive/tenant/foo/application/bar/instance/default/environment/prod/region/aws-us-east-1c | jq .
{
  "message": "Set global routing status for foo.bar in prod.aws-us-east-1c to OUT"
}
</pre>

<p>Inspecting the status will now show the status set to <em>out</em>.</p>


<h3>Set zone in</h3>

<p>To set the zone back in and have it continue receiving requests:</p>
<pre>
$ curl -XDELETE https://console.vespa.oath.cloud/api/routing/v1/inactive/tenant/foo/application/bar/instance/default/environment/prod/region/aws-us-east-1c | jq .
{
  "message": "Set global routing status for foo.bar in prod.aws-us-east-1c to IN"
}
</pre>
