---
# Copyright Verizon Media. All rights reserved.
title: "album-recommendation-searcher"
---

<p>
Vespa Cloud is at the moment <a href="mailto:info@vespa.ai?subject=Sign+me+up!">invite only</a>.
</p><p>
This sample app adds custom java plugin code, system and staging tests,
and is an introduction into integrating with a CI/CD pipeline.
It extends the
<a href="/vespa-cloud-quick-start">Quick Start</a> with:
<ul>
    <li>A <a href="http://docs.vespa.ai/documentation/searcher-development.html">Searcher</a>
      component for query and result processing.
      <ul>
        <li>See <a href="https://github.com/vespa-engine/sample-apps/tree/master/vespa-cloud/album-recommendation-docproc">
          album-recommendation-docproc</a> for a
          <a href="https://docs.vespa.ai/documentation/document-processing.html">Document Processing</a> example.</li>
      </ul>
    </li>
    <li>Custom config for the searcher, to demonstrate atomic code and config deployment.</li>
    <li>A System and staging test used in <a href="/automated-deployments">automated-deployments</a>.</li>
</ul>
Prerequisites: git, Java 11, mvn 3.6.1 and openssl.
See <a href="https://docs.vespa.ai/documentation/getting-started.html">Getting Started</a> for troubleshooting.
Security notes:
<ul>
  <li>To deploy, a <a href="/security-model#keys">user API key</a> is required, see step 4.</li>
  <li>To read and write to the instance's endpoint, a certificate and a private key is required, see step 2.
    Find more details in <a href="/security-model.html#data-plane">Data Plane</a>,
    see "Client certificate".</li>
</ul>
</p>
<hr />
<ol>
  <li><p>
    Download sample apps:
<pre data-test="exec">
$ git clone https://github.com/vespa-engine/sample-apps.git && \
  cd sample-apps/vespa-cloud/album-recommendation-searcher
</pre>
  </p></li><li><p>
    Get a X.509 certificate and private key.
    Create a self-signed certificate / private key:
<pre data-test="exec">
$ openssl req -x509 -nodes -days 14 -newkey rsa:4096 \
  -subj "/CN=cloud.vespa.example" \
  -keyout data-plane-private-key.pem -out data-plane-public-cert.pem
</pre>
  </p></li><li><p>
    Add certificate to application package (it must be copied as <em>clients.pem</em>):
<pre data-test="exec">
$ mkdir -p src/main/application/security && \
  cp data-plane-public-cert.pem src/main/application/security/clients.pem
</pre>
  </p></li><li><p>
    At <a href="http://console.vespa.ai">console.vespa.ai</a>,
    choose tenant and click <em>Keys</em> to generate and save the <em>user API key</em>.
    The key is saved to <code>$HOME/Downloads/USER.TENANTNAME.pem</code>.
    Then click "Create application" - use any name for the application.
  </p></li><li><p>
    Update <code>tenant</code> and <code>application</code> in <code>pom.xml</code> â€”
    use the values entered in the console in 4.
  </p></li><li><p>
    Build the app, deploy it to the <code>dev</code> environment and wait for it to start -
    update <code>apiKeyFile</code> to be the file downloaded above:
<pre>
$ mvn clean package vespa:deploy -DapiKeyFile=$HOME/Downloads/USER.TENANTNAME.pem
</pre>
  </p></li><li><p>
    Alternatively, put the key in an <a href="/automated-deployments#keys">environment variable</a>:
<pre data-test="exec">
$ API_KEY=`echo $VESPA_TEAM_API_KEY | openssl base64 -A -a -d`
$ mvn clean package vespa:deploy -DapiKey="$API_KEY"
</pre>
  </p></li><li><p>
    Now is a good time to read <a href="/automated-deployments">automated-deployments</a>,
    as first time deployments takes a few minutes.
    The endpoint URL is printed in the <em>Install application</em> section when the deployment is successful -
    store this (change <em>root</em> to actual name) for later steps and test it
    (the massive JSON output is expected).
    Also see <a href="/security-model#using-a-browser">using a browser</a>:
<pre data-test="exec">
$ ENDPOINT=https://root.album-rec-searcher.vespa-team.aws-us-east-1c.dev.public.vespa.oath.cloud
$ curl --cert ./data-plane-public-cert.pem --key ./data-plane-private-key.pem $ENDPOINT
</pre>
  </p></li><li><p>
    Feed documents:
<pre data-test="exec" data-test-assert-contains="id:mynamespace:music::">
$ curl --cert ./data-plane-public-cert.pem --key ./data-plane-private-key.pem \
  -H "Content-Type:application/json" --data-binary @src/test/resources/A-Head-Full-of-Dreams.json \
  $ENDPOINT/document/v1/mynamespace/music/docid/1
$ curl --cert ./data-plane-public-cert.pem --key ./data-plane-private-key.pem \
  -H "Content-Type:application/json" --data-binary @src/test/resources/Love-Is-Here-To-Stay.json \
  $ENDPOINT/document/v1/mynamespace/music/docid/2
$ curl --cert ./data-plane-public-cert.pem --key ./data-plane-private-key.pem \
  -H "Content-Type:application/json" --data-binary @src/test/resources/Hardwired...To-Self-Destruct.json \
  $ENDPOINT/document/v1/mynamespace/music/docid/3
</pre>
  </p></li><li><p>
    Dump all document using <a href="https://docs.vespa.ai/documentation/content/visiting.html">visit</a>:
<pre data-test="exec" data-test-assert-contains="id:mynamespace:music::">
$ curl --cert ./data-plane-public-cert.pem --key ./data-plane-private-key.pem \
  "$ENDPOINT/document/v1/mynamespace/music/docid?wantedDocumentCount=100"
</pre>
  </p></li><li><p>
    Recommend albums, send user profile in query:
<pre data-test="exec" data-test-assert-contains="id:mynamespace:music::">
$ curl --cert ./data-plane-public-cert.pem --key ./data-plane-private-key.pem \
  "$ENDPOINT/search/?ranking=rank_albums&yql=select%20%2A%20from%20sources%20%2A%20where%20sddocname%20contains%20%22music%22%3B&ranking.features.query(user_profile)=%7B%7Bcat%3Apop%7D%3A0.8%2C%7Bcat%3Arock%7D%3A0.2%2C%7Bcat%3Ajazz%7D%3A0.1%7D"
</pre>
    Limit to albums with the term "to" in title:
<pre data-test="exec" data-test-assert-contains="id:mynamespace:music::">
$ curl --cert ./data-plane-public-cert.pem --key ./data-plane-private-key.pem \
  "$ENDPOINT/search/?ranking=rank_albums&yql=select%20%2A%20from%20sources%20%2A%20where%20album%20contains%20%22to%22%3B&ranking.features.query(user_profile)=%7B%7Bcat%3Apop%7D%3A0.8%2C%7Bcat%3Arock%7D%3A0.2%2C%7Bcat%3Ajazz%7D%3A0.1%7D"
</pre>
  </p></li><li><p>
    Vespa Cloud has support for running <em>system</em> and <em>staging</em> tests,
    used in <a href="/automated-deployments">automated-deployments</a>.
    These tests are run as JUnit tests.
    To develop such tests, deploy the application to <em>dev</em> (like above) and run tests like
    <a href="https://github.com/vespa-engine/sample-apps/blob/master/vespa-cloud/album-recommendation-searcher/src/test/java/ai/vespa/example/album/FeedAndSearchSystemTest.java">
    FeedAndSearchSystemTest</a>:
<pre data-test="exec" data-test-assert-contains="BUILD SUCCESS">
$ mvn test \
  -Dtest.categories=system \
  -DdataPlaneKeyFile=data-plane-private-key.pem -DdataPlaneCertificateFile=data-plane-public-cert.pem \
  -DapiKey="$API_KEY"
</pre>
    The <code>apiKey</code> is used to fetch the <em>dev</em> instance's endpoints.
    The data plane key and certificate pair is used by
    <a href="https://github.com/vespa-engine/vespa/blob/master/tenant-cd-api/src/main/java/ai/vespa/hosted/cd/Endpoint.java">ai.vespa.hosted.cd.Endpoint</a>
    to access the application endpoint.
    Find more details in <a href="/reference/testing">testing</a> and
    <a href="/reference/vespa-cloud-api.html">Vespa Cloud API</a>.
  </p></li><li><p>
    To run tests against a deployment running in Docker on localhost (instead of using <em>dev</em>),
    configure endpoint location:
<pre>
{
    "localEndpoints": {
        "container": "http://localhost:8080/"
    }
}
</pre>
    See <a href="reference/testing#system-tests">system tests</a> for details.
    Refer to <a href="https://github.com/vespa-engine/sample-apps/tree/master/album-recommendation-selfhosted">
    album-recommendation-selfhosted</a> for how to create the application package.
  </p></li><li><p>
    When <em>system</em> and <em>staging</em> tests are ready, deploy to production:
<pre data-test="exec" data-test-assert-contains="BUILD SUCCESS">
$ mvn vespa:compileVersion -DapiKey="$API_KEY"
$ mvn -P fat-test-application \
  -Dvespa.compile.version="$(cat target/vespa.compile.version)" \
  -DapiKey="$API_KEY" \
  package vespa:submit
</pre>
  </p></li>
</ol>
